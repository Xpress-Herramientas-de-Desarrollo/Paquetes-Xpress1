name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

permissions:
  contents: read
  pull-requests: write

jobs:
  # Job 1: ValidaciÃ³n de Composer y sintaxis PHP
  validate:
    name: ValidaciÃ³n de Composer y Sintaxis PHP
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, intl, mysqli
        coverage: none

    - name: Validar composer.json y composer.lock
      run: composer validate --strict

    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Instalar dependencias
      run: composer install --prefer-dist --no-progress --no-interaction

    - name: Verificar sintaxis PHP
      run: |
        find app -name "*.php" -type f -exec php -l {} \; | grep -v "No syntax errors"

  # Job 2: AnÃ¡lisis de cÃ³digo estÃ¡tico
  code-quality:
    name: AnÃ¡lisis de Calidad de CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, intl, mysqli
        coverage: none

    - name: Cache Composer packages
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Instalar dependencias
      run: composer install --prefer-dist --no-progress --no-interaction

    - name: Ejecutar PHP CS Fixer (dry-run)
      run: |
        vendor/bin/php-cs-fixer fix --dry-run --diff --verbose || true

    - name: Verificar estÃ¡ndares de CodeIgniter
      run: |
        vendor/bin/phpcs app --standard=vendor/codeigniter/coding-standard/CodeIgniter || true

  # Job 3: Tests con mÃºltiples versiones de PHP
  test:
    name: Tests PHP ${{ matrix.php-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version:
          - '8.1'
          - '8.2'
          - '8.3'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: bd_xpress_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar PHP ${{ matrix.php-version }}
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, intl, mysqli, xdebug
        coverage: xdebug
        ini-values: xdebug.mode=coverage

    - name: Cache Composer packages
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ matrix.php-version }}-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-${{ matrix.php-version }}-
          ${{ runner.os }}-php-

    - name: Instalar dependencias
      run: composer install --prefer-dist --no-progress --no-interaction

    - name: Configurar base de datos de pruebas
      run: |
        cp env .env
        echo "database.tests.hostname = 127.0.0.1" >> .env
        echo "database.tests.database = bd_xpress_test" >> .env
        echo "database.tests.username = root" >> .env
        echo "database.tests.password = root" >> .env
        echo "database.tests.DBDriver = MySQLi" >> .env
        echo "database.tests.port = 3306" >> .env

    - name: Ejecutar migraciones de base de datos
      run: php spark migrate -g tests || true

    - name: Ejecutar tests con PHPUnit
      run: vendor/bin/phpunit --coverage-text --coverage-clover=build/logs/clover.xml

    - name: Generar reporte de coverage
      if: matrix.php-version == '8.1'
      run: vendor/bin/phpunit --coverage-html=build/logs/html --coverage-text

    - name: Subir coverage a Codecov (opcional)
      if: matrix.php-version == '8.1'
      uses: codecov/codecov-action@v3
      with:
        file: ./build/logs/clover.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Subir artefactos de coverage
      if: matrix.php-version == '8.1'
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: build/logs/html
        retention-days: 30

    - name: Subir reportes de tests
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-php${{ matrix.php-version }}
        path: build/logs/logfile.xml
        retention-days: 7

  # Job 4: AuditorÃ­a de seguridad
  security:
    name: AuditorÃ­a de Seguridad
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, intl, mysqli
        coverage: none

    - name: Cache Composer packages
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Instalar dependencias
      run: composer install --prefer-dist --no-progress --no-interaction

    - name: AuditorÃ­a de dependencias con Composer
      run: composer audit --format=json > security-audit.json || true

    - name: Mostrar vulnerabilidades encontradas
      run: |
        if [ -s security-audit.json ]; then
          echo "âš ï¸ Vulnerabilidades encontradas:"
          cat security-audit.json
        else
          echo "âœ… No se encontraron vulnerabilidades conocidas"
        fi

  # Job 5: Build y verificaciÃ³n final
  build:
    name: Build Final
    runs-on: ubuntu-latest
    needs: [validate, test]
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, intl, mysqli
        coverage: none

    - name: Cache Composer packages
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Instalar dependencias (sin dev)
      run: composer install --prefer-dist --no-progress --no-interaction --no-dev --optimize-autoloader

    - name: Verificar estructura del proyecto
      run: |
        echo "âœ… Verificando estructura del proyecto..."
        [ -f "public/index.php" ] && echo "âœ“ public/index.php existe" || exit 1
        [ -d "app" ] && echo "âœ“ Directorio app existe" || exit 1
        [ -d "system" ] && echo "âœ“ Directorio system existe" || exit 1
        [ -f "composer.json" ] && echo "âœ“ composer.json existe" || exit 1
        echo "âœ… Estructura del proyecto correcta"

    - name: Optimizar autoloader
      run: composer dump-autoload --optimize --classmap-authoritative

  # Job 6: NotificaciÃ³n de resultados (opcional)
  notify:
    name: NotificaciÃ³n de Resultados
    runs-on: ubuntu-latest
    needs: [validate, code-quality, test, security, build]
    if: always()
    
    steps:
    - name: Resumen del CI
      run: |
        echo "## ðŸ“Š Resumen del CI/CD Pipeline" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Estado |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ValidaciÃ³n | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Calidad de CÃ³digo | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Seguridad | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY

